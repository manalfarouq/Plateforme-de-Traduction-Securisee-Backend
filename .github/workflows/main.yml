
name: Run Unit Tests

on: 
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    # Variables d'environnement pour les tests
    env:
      SK: ekchvidkoiis693jkclploocdnjsof802mdjcjvhfis_test
      ALG: HS256
      HF_TOKEN: test_hf_token_for_ci
      ACCESS_TOKEN_EXPIRE_MINUTES: 60
      DB_HOST: localhost
      DB_PORT: 5432
      DB_NAME: traduction_test_db
      DB_USER: traduction_test_user
      DB_PASSWORD: traduction_test_password_123
    
    # Service PostgreSQL pour les tests
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: ${{ env.DB_USER }}
          POSTGRES_PASSWORD: ${{ env.DB_PASSWORD }}
          POSTGRES_DB: ${{ env.DB_NAME }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx
      
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Attendre que PostgreSQL soit prÃªt
        run: |
          until pg_isready -h localhost -p 5432 -U ${{ env.DB_USER }}; do
            echo 'Waiting for PostgreSQL...'
            sleep 1
          done
        timeout-minutes: 5
      
      - name: Initialise database
        env:
          PGPASSWORD: ${{ env.DB_PASSWORD }}
        run: |
          psql -h localhost -U ${{ env.DB_USER }} -d ${{ env.DB_NAME }} -c "
          CREATE TABLE IF NOT EXISTS users (
            id SERIAL PRIMARY KEY,
            username VARCHAR(100) UNIQUE NOT NULL,
            password VARCHAR(255) NOT NULL,
            role VARCHAR(50) NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          );
          GRANT ALL PRIVILEGES ON TABLE users TO ${{ env.DB_USER }};
          GRANT USAGE, SELECT ON SEQUENCE users_id_seq TO ${{ env.DB_USER }};
          "
      
      - name: Run tests with coverage
        run: |
          PYTHONPATH=$(pwd) python3.11 -m pytest tests/ --cov=app --cov-report=term --cov-report=xml -v